# 測定セットアップガイド

## 目的
- `signal-specifications.md` で定義したテスト信号を、再現性の高い条件で再生・録音する。
- パイロットトーンを用いたアライメント（`align`）やドリフト推定（`drift`）が安定に動作するよう、クロックとレベルを揃える。

## 共通条件（必須）
- サンプルレート: 48 kHz（高帯域検証のみ 96 kHz 可）
- ビット深度: 24-bit PCM（または 32-bit float）
- チャンネル: ステレオ(2ch)推奨（モノラル収録でも内部で2chへ複製される）。
- プレーヤー: ビットパーフェクト（独占モード / `hw:` 等）。OS/EQ/AGC/ノーマライズはすべて無効化。
- レベル: デジタルゲインは 0 dB。ピークは -1 dBFS 以下。パイロットは -6 dBFS が目安。
- トリミング禁止: リード/テイルの無音を含めて丸ごと録音する。

## 推奨ハードウェア構成
- 共有クロック: DAC と ADC を同一クロックで駆動（デジタルループバックが最安定）。外部 DAC を測る場合も、可能ならワードクロック/デジタル出力で同期。
- オーディオI/F: 24-bit, 48 kHz 固定で動作するインターフェース。ASRC, DSP, ノイズ抑制を無効化。
- ケーブル: デジタルは短尺かつ確実な接続。アナログ計測は十分なヘッドルームを確保し、不要なDI/エフェクトを避ける。

## シナリオ別手順

### 1) デジタルループバック測定（動作確認/回帰テスト向け）
1. PC内で再生・録音とも同一インターフェース/クロックに設定（48 kHz / 24-bit）。
2. `uv run microstructure-metrics generate notched-noise --with-metadata` 等でテスト信号を用意。
3. プレーヤーをビットパーフェクトに設定し、ヘッドルームを確認（ピーク < -1 dBFS）。
4. ファイルを再生し、録音先 WAV を取得。トリミングしない。
5. `align` → `drift` → `report` を実行し、ワークフロー全体を確認。

### 2) 外部DAC/AMP測定（実機比較向け）
1. 再生側: テスト信号を 48 kHz / 24-bit のまま出力。プレーヤーの EQ/リサンプルは無効。
2. 増幅: 測定対象機器を所定の負荷に接続し、クリップしない入力レベルに調整。
3. 収音: ADC 側も 48 kHz / 24-bit。ゲインはパイロットで -6 dBFS 程度になるよう調整し、6 dB 以上のヘッドルームを確保。
4. ファイル化: ステレオ(2ch)で収録し、`{signal_name}_dut.wav` のように命名。メタデータ JSON がある場合は同じディレクトリに置く。
5. 検証: 後述の「録音後チェック」を満たすことを確認。

## 録音後チェック
- ファイル長: 先頭/末尾の無音（各500 ms）と2つのパイロット（各100 ms）が存在する。
- レベル: ピーク < -1 dBFS、パイロットはおおよそ -6 dBFS。クリップなし。
- サンプルレート/ビット深度/チャンネルがメタデータと一致。
- ドリフト: 両端パイロットの開始位置差分から概算し、過大でないことを確認（`drift` サブコマンド推奨）。

## 次のステップ
- 信号仕様・命名規則: `docs/jp/signal-specifications.md`
- CLI/API リファレンス: `docs/jp/api-cli-reference.md`
- 指標の読み解き: `docs/jp/metrics-interpretation.md`
