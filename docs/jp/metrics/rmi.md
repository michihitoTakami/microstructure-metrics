# 残差マイクロストラクチャ情報（RMI: Residual Microstructure Information）

## 1. 概要

### 目的と意義

**残差マイクロストラクチャ情報（RMI）** 指標は、最良線形適合を除去した後の参照信号とDUT（被測定デバイス）の差異の性質を特徴付けます。THD+Nなどの従来の指標は絶対的な歪みレベルを測定しますが、RMIは残差信号の**構造**に焦点を当て、無害なノイズと、リンギング、非線形歪み、変調スメアなどの知覚的に有意なアーティファクトを区別します。

### 測定対象

RMIはまず、参照とDUT間の最適線形変換を推定します：
- **スケール** \(a\)：振幅ゲイン
- **遅延** \(\Delta\)：サンプル単位の微小遅延（通常はサブミリ秒）

この最良適合線形マッチを除去した後、残差は以下のように定義されます：

$$
r(t) = \text{dut}(t) - a \cdot \text{ref}(t - \Delta)
$$

RMIはこの残差 \(r(t)\) を3つの直交する次元で分析します：

1. **バースト性（Burstiness）**：尖度、クレストファクタ、99パーセンタイル振幅を介してインパルス性を測定
2. **変調構造（Modulation structure）**：高速包絡変調エネルギー（4–64 Hz範囲）を定量化
3. **白色性（Whiteness）**：スペクトル平坦度と自己相関を評価し、ノイズとトーナルアーティファクトを区別

### なぜRMIが重要か

デバイスは低いRMS誤差を示しながらも、知覚的に顕著なアーティファクトを導入する可能性があります。RMIは以下を明らかにします：
- **フィルタリンギング**：高い尖度と自己相関ピークとして現れる
- **非線形歪み**：構造化されたスペクトル内容として現れる（低いスペクトル平坦度）
- **包絡アーティファクト**：高変調レートエネルギーの上昇により検出
- **位相歪み**：白色ノイズではなく残差構造として現れる

理想的なデバイスはノイズ様の残差を生成します（高いスペクトル平坦度、低い尖度、ほぼゼロの自己相関ピーク）。アーティファクトは、RMI指標に明確な特徴を持つ構造化された残差を生成します。

### 典型的な応用場面

- 再構成フィルタからの微妙なリンギングまたはプレエコーの検出
- 低いTHD+Nにマスクされた非線形アーティファクトの特定
- 非可逆コーデックまたはダイナミクスプロセッサでの包絡保存の評価
- 異なるアナログアンプトポロジー間の残差「クリーンさ」の比較
- 相互変調または変調歪みの診断

---

## 2. 数学的定義

### 2.1 最良線形適合の推定

#### 遅延推定

微小遅延 \(\Delta\) は正規化相互相関により推定されます：

$$
\rho(\tau) = \frac{\sum_n \text{ref}(n) \cdot \text{dut}(n - \tau)}{\sqrt{\sum_n \text{ref}(n)^2} \cdot \sqrt{\sum_n \text{dut}(n)^2}}
$$

ここで \(\tau\) は \([-T_{\max}, T_{\max}]\) の範囲（デフォルト：\(T_{\max} = 5\) ms）。

**粗い遅延**（整数サンプル）：
$$
\tau_{\text{coarse}} = \arg\max_\tau \rho(\tau)
$$

**精密化された遅延**（サブサンプル精度）：

`refine_delay=True` の場合、相関ピークとその隣接点に放物線補間を適用して、小数サンプル精度を得ます：

$$
\Delta_{\text{refined}} = \tau_{\text{coarse}} + \frac{\rho(\tau-1) - \rho(\tau+1)}{2[\rho(\tau-1) - 2\rho(\tau) + \rho(\tau+1)]}
$$

**残差エネルギー精密化**（オプション）：

`refine_fit=True` の場合、スケール適合後に残差エネルギーを最小化するために、\(\Delta_{\text{refined}}\) の周辺で局所探索を実行します（パラメータはSection 3.1参照）。

#### 信号整列とトリミング

参照を \(\Delta\) だけ線形補間によりシフトし、補間が適切に定義される有効なオーバーラップ領域に両方の信号をトリミングします。これにより、等長の整列信号 \(\text{ref}_{\text{aligned}}\) と \(\text{dut}_{\text{aligned}}\) が生成されます。

#### スケール推定

最小二乗法による最適スケール \(a\) を計算します：

$$
a = \frac{\sum_n \text{dut}_{\text{aligned}}(n) \cdot \text{ref}_{\text{aligned}}(n)}{\sum_n \text{ref}_{\text{aligned}}(n)^2}
$$

分母が閾値 \(\epsilon = 10^{-12}\) 未満の場合、\(a = 0\) とします。

### 2.2 残差計算

$$
r(n) = \text{dut}_{\text{aligned}}(n) - a \cdot \text{ref}_{\text{aligned}}(n)
$$

**基本統計**：
- RMS：\(\text{RMS}_r = \sqrt{\frac{1}{N} \sum_n r(n)^2}\)
- ピーク：\(\text{Peak}_r = \max_n |r(n)|\)

### 2.3 バースト性 / インパルス性

#### 尖度（Kurtosis）

分散の2乗で正規化された4次モーメント：

$$
\text{Kurtosis} = \frac{\frac{1}{N} \sum_n (r(n) - \mu_r)^4}{\left(\frac{1}{N} \sum_n (r(n) - \mu_r)^2\right)^2}
$$

ここで \(\mu_r = \frac{1}{N} \sum_n r(n)\) は平均です。

- **ガウスノイズ**：\(\approx 3.0\)
- **インパルス性アーティファクト**（リンギング、クリック）：\(> 3.5\)
- **一様/平坦な残差**：\(< 2.5\)

#### クレストファクタ

ピーク対RMS比：

$$
\text{Crest} = \frac{\text{Peak}_r}{\max(\text{RMS}_r, \epsilon)}
$$

- **白色ノイズ**：\(\approx 3\)–5（dBで：10–14 dB）
- **インパルス性**：\(> 6\)（> 15 dB）

#### 99パーセンタイル絶対値

$$
p_{99} = \text{quantile}_{0.99}(|r(n)|)
$$

テール挙動を捉える；上昇した値は散発的な大きな逸脱（ドロップアウト、クリッピング、リンギング）を示します。

### 2.4 変調構造

ヒルベルト変換を介して残差の包絡を抽出します：

$$
\text{env}(n) = |\mathcal{H}(r(n))|
$$

DC成分を除去：

$$
\tilde{\text{env}}(n) = \text{env}(n) - \frac{1}{N} \sum_k \text{env}(k)
$$

FFTにより変調スペクトラムを計算：

$$
M(f_{\text{mod}}) = |\text{FFT}(\tilde{\text{env}})| \quad \text{where } f_{\text{mod}} = \text{FFT周波数}
$$

変調周波数帯域のパワー：

$$
E_{\text{band}} = \sum_{f \in [f_{\text{low}}, f_{\text{high}}]} |M(f)|^2
$$

**総変調エネルギー**（デフォルト帯域：0.5–64 Hz）：

$$
E_{\text{total}} = E_{[0.5, 64]}
$$

**高変調比**：

$$
\text{HighModRatio}_{4-64} = \frac{E_{[4, 64]}}{E_{\text{total}}}
$$

$$
\text{HighModRatio}_{10-64} = \frac{E_{[10, 64]}}{E_{\text{total}}}
$$

- **ノイズ様残差**：低い比率（\(< 0.5\)）；エネルギーがDCを含むすべての変調周波数に分散
- **アーティファクト支配**：高い比率（\(> 0.7\)）；エネルギーがより高い変調レートに集中し、構造化された包絡変動を示す

### 2.5 白色性

#### スペクトル平坦度

パワースペクトル密度がどれだけ均一かを測定：

$$
\text{SpectralFlatness} = \frac{\exp\left(\frac{1}{K} \sum_{k=0}^{K-1} \log(\text{PSD}(k))\right)}{\frac{1}{K} \sum_{k=0}^{K-1} \text{PSD}(k)}
$$

ここで \(\text{PSD}(k)\) はパワースペクトル密度（Welch法により4096サンプルセグメントで計算）。

- **白色ノイズ**：\(\approx 1.0\)
- **トーナルアーティファクト**（リンギング、高調波歪み）：\(< 0.5\)
- **狭帯域ノイズ**：\(< 0.7\)

#### 自己相関ピーク超過

残差（DC除去済み）の自己相関を計算：

$$
\text{AC}(\ell) = \frac{1}{N} \sum_{n=0}^{N-|\ell|-1} r(n) \cdot r(n + |\ell|)
$$

\(\text{AC}(0)\) で正規化：

$$
\hat{\text{AC}}(\ell) = \frac{\text{AC}(\ell)}{\text{AC}(0)}
$$

探索範囲 \(|\ell| \leq \ell_{\max}\)（デフォルト：20 ms）内でラグ0を除く最大絶対値を見つけます：

$$
\text{ACPeakExcess} = \max_{\ell \neq 0} |\hat{\text{AC}}(\ell)|
$$

$$
\text{ACPeakLag} = \arg\max_{\ell \neq 0} |\hat{\text{AC}}(\ell)|
$$

- **白色ノイズ**：\(\text{ACPeakExcess} \approx 0\)
- **リンギング/共鳴**：\(\text{ACPeakExcess} > 0.1\)、ラグはリンギング周期に対応
- **周期的アーティファクト**：\(\text{ACPeakExcess} > 0.2\)

---

## 3. 実装詳細

### 3.1 パラメータと推奨値

| パラメータ | 型 | デフォルト | 範囲/備考 |
|-----------|---|---------|---------|
| `sample_rate` | int | – | オーディオサンプルレート (Hz) |
| `max_delay_lag_ms` | float | 5.0 | 最大遅延探索範囲（ms）；典型的なジッタと整列不確実性をカバー |
| `refine_delay` | bool | True | 相関ピークのサブサンプル放物線補間を有効化 |
| `refine_fit` | bool | True | 精密化された遅延周辺での局所残差エネルギー最小化を有効化 |
| `autocorr_max_lag_ms` | float | 20.0 | 自己相関白色性チェックの最大ラグ（ms） |
| `modulation_total_band_hz` | tuple | (0.5, 64.0) | 変調エネルギー比の分母帯域（Hz） |
| `modulation_high_band_hz` | tuple | (4.0, 64.0) | 高変調比の分子帯域（4–64 Hz） |
| `modulation_very_high_band_hz` | tuple | (10.0, 64.0) | 超高変調比の分子帯域（10–64 Hz） |

### 3.2 アルゴリズム概要

RMI計算は以下のステップで構成されます：

1. **遅延推定**：オプションのサブサンプル精密化付き相互相関
2. **残差エネルギー精密化**（オプション）：残差RMSを最小化する局所探索
3. **整列とトリミング**：参照を \(\Delta\) だけ線形補間し、有効オーバーラップにトリミング
4. **スケール適合**：最小二乗法による最適ゲイン \(a\)
5. **残差計算**：\(r(t) = \text{dut}(t) - a \cdot \text{ref}(t - \Delta)\)
6. **バースト性指標**：尖度、クレストファクタ、99パーセンタイル
7. **変調構造**：ヒルベルト包絡 → FFT → 帯域エネルギー比
8. **白色性指標**：Welch PSD → スペクトル平坦度；自己相関 → ピーク超過とラグ

実装詳細は `src/microstructure_metrics/metrics/residual.py` で確認できます。

### 3.3 エッジケースと特別な処理

1. **空または単一サンプル信号**：参照またはDUTが空、または長さが不一致の場合、`ValueError` を送出します。

2. **低エネルギー信号**：参照エネルギーが \(\epsilon = 10^{-12}\) 未満の場合、スケールはデフォルトで0となり、残差はDUTに等しくなります（スケーリングなし）。

3. **大きな遅延**：推定遅延が非常に大きく、トリミング後のサンプルが不足する場合、`ValueError` を送出し、メッセージ `"delay too large for trimming"` または `"insufficient samples after delay compensation"` を表示します。信号長を増やすか、`max_delay_lag_ms` を減らしてください。

4. **短い信号での自己相関**：信号が自己相関ウィンドウより短い場合、関数は `autocorr_max_lag_ms` を利用可能な長さにクランプします。

5. **ナイキスト外の変調帯域**：変調帯域の上限周波数がナイキストを超える場合、`ValueError` を送出します。サンプルレートに基づいて `modulation_total_band_hz` を調整してください（変調帯域は通常 <100 Hz なので問題になることは稀）。

6. **無限またはNaN値**：スケール適合およびすべての指標計算は非有限値をチェックし、オーバーフローまたはアンダーフローが発生した場合はデフォルトで0とします。

### 3.4 計算複雑度

- **遅延推定**：\(\mathcal{O}(N \log N)\)（FFTベース相互相関）
- **残差エネルギー精密化**：\(\mathcal{O}(k \cdot N)\)（\(k\) は候補遅延数、通常約30）
- **ヒルベルト変換**：\(\mathcal{O}(N \log N)\)（FFTベース）
- **Welch PSD**：\(\mathcal{O}(N \log N)\)（重複FFT）
- **自己相関**：\(\mathcal{O}(N \log N)\)（FFTベース）
- **全体**：FFT操作に支配されて \(\mathcal{O}(N \log N)\)

実行時間の目安：48 kHz、10秒で 50 ms未満（最新ハードウェア）。

**メモリ**：ピークメモリ使用量は \(\mathcal{O}(N)\)（整列信号と中間変換の保存用）。

---

## 4. 解釈ガイドライン

### 4.1 残差基本統計

**RMS** (`residual_rms`)：
- 線形スケールでの残差の絶対レベル
- **低いほど良好**；参照RMSまたは予想されるノイズフロアと比較
- 例：参照RMSが0.1で残差RMSが0.001の場合、デバイスは1%のエラーを導入

**ピーク** (`residual_peak`)：
- 最大瞬時残差振幅
- 最悪ケースの逸脱（クリッピング、ドロップアウト、リンギングピーク）を捉える
- **低いほど良好**；高忠実度デバイスでは理想的に <0.01

### 4.2 バースト性 / インパルス性

**尖度** (`kurtosis`)：
- **≈ 3.0**：ガウス様残差（無害なノイズ）
- **3.5–5.0**：中程度のインパルス性（散発的なクリック、軽度のリンギング）
- **> 5.0**：高いインパルス性（強いリンギング、ドロップアウト、クリッピングアーティファクト）
- **< 2.5**：過度に平坦な分布（DCオフセットまたは極端なリミッティングを示す可能性）

**クレストファクタ** (`crest_factor`)：
- **3–5**：ノイズ様（10–14 dB）
- **6–10**：中程度のインパルス性（15–20 dB）
- **> 10**：高いインパルス性（> 20 dB）；リンギングまたはクリックを疑う

**99パーセンタイル** (`p99_abs`)：
- ピークほど単一サンプル外れ値に敏感ではなくテール振幅を捉える
- RMSと比較：`p99_abs` が \(3 \times \text{RMS}\) よりはるかに大きい場合、インパルス性アーティファクトを疑う

### 4.3 変調構造

**高変調比** (`high_mod_ratio_4_64`, `high_mod_ratio_10_64`)：
- **< 0.5**：エネルギーがDCを含むすべての変調周波数に分散；ノイズ様
- **0.5–0.7**：中程度の構造；一部の包絡アーティファクトだが支配的ではない
- **> 0.7**：高速変調レート（4–64 Hzまたは10–64 Hz）への高い集中；包絡スメア、変調歪み、または非可逆コーデックアーティファクトを疑う

これらの比率は、残差が時間的包絡構造を持つか（高比率）、ノイズ様か（低比率）を明らかにします。

### 4.4 白色性

**スペクトル平坦度** (`spectral_flatness`)：
- **≥ 0.9**：非常に白色；残差はすべての周波数でノイズ様
- **0.7–0.89**：中程度の着色；一部のスペクトル構造だが深刻ではない
- **< 0.7**：トーナルまたは狭帯域アーティファクト；高調波歪み、共鳴、またはフィルタリンギングを疑う

**自己相関ピーク超過** (`autocorr_peak_excess`)：
- **< 0.05**：白色ノイズ様；有意な周期構造なし
- **0.05–0.1**：弱い周期成分；軽度のリンギングまたは低レベル共鳴
- **> 0.1**：強い周期構造；フィルタリンギング、共鳴、または変調アーティファクトを疑う

**自己相関ピークラグ** (`autocorr_peak_lag_ms`)：
- 自己相関のピーク時間ラグ（ラグ0を除く）
- リンギングまたは共鳴アーティファクトの周期に対応
- 例：`autocorr_peak_lag_ms = 0.5` ms は約2 kHzのリンギングアーティファクトを示唆

### 4.5 解釈のヒント

**シナリオ：低い残差RMS、尖度 ≈ 3、スペクトル平坦度 ≈ 0.95、自己相関ピーク ≈ 0**
- 解釈：理想的；残差は白色ノイズ様。デバイスは最小限の構造化アーティファクトを追加。

**シナリオ：中程度の残差RMS、尖度 = 5.5、クレストファクタ = 12 dB、自己相関ピーク = 0.15（0.8 ms）**
- 解釈：周期約0.8 ms（≈1.25 kHz共鳴）のインパルス性リンギングアーティファクト。フィルタリンギングまたは再構成アーティファクトの可能性。

**シナリオ：高いスペクトル平坦度（0.9）だが高い変調比（0.8）**
- 解釈：残差は周波数では白色だが構造化された包絡変動を持つ。包絡クリッピングまたはAM歪みを疑う。

**シナリオ：低いスペクトル平坦度（0.5）、低い尖度（2.5）、低い自己相関ピーク（0.03）**
- 解釈：強い周期性のないトーナル着色。低レベル高調波歪みまたはスペクトラム全体に広がったIMDを示す可能性。

---

## 5. サンプル信号で何が分かるか

### 5.1 `generate.py` のテスト信号利用

リポジトリには複数のテスト信号タイプ（`src/microstructure_metrics/cli/generate.py` 参照）が含まれており、RMIの解釈に有用です：

#### A. **ホワイトノイズ** (`white-noise`)

**RMI が明かすこと**：
- **理想的デバイス**：残差も白色ノイズ様であるべき（尖度 ≈ 3、スペクトル平坦度 ≈ 0.9、自己相関ピーク ≈ 0）
- **非線形デバイス**：尖度が増加（クリッピング、ドロップアウト）；スペクトル平坦度が減少（高調波内容）
- **共鳴デバイス**：自己相関ピークが増加、ラグは共鳴周波数を明らかにする

---

#### B. **トーンバースト** (`tone-burst`)

**RMI が明かすこと**：
- **リンギング**：上昇した尖度、自己相関ピーク、リンギング周波数に対応するラグ
- **プレリンギング**（線形位相フィルタ）：高変調比が増加、スペクトル平坦度が減少
- **位相歪み**：RMSが低くても残差がトーナル内容を持つ（低いスペクトル平坦度）

---

#### C. **マルチトーン** (`multitone`)

**RMI が明かすこと**：
- **相互変調歪み**：スペクトル平坦度が減少、残差がIMD周波数でトーナル内容を持つ
- **位相非線形性**：IMD積が互いに変調する場合、高変調比が増加する可能性
- **理想的デバイス**：残差は白色を維持し、尖度 ≈ 3

---

#### D. **スイープサイン** (`sweep`)

**RMI が明かすこと**：
- **周波数依存非線形性**：デバイスが非線形な帯域で尖度とクレストファクタが増加
- **共鳴**：特定周波数で自己相関ピークが増加
- **群遅延異常**：変調構造として現れる可能性（高変調比の増加）

---

### 5.2 比較マトリックス：指標の意味

| 信号タイプ | 期待されるRMI（理想的デバイス） | 劣化時の解釈 |
|-----------|-------------------------|------------|
| `white-noise` | 尖度 ≈ 3、SF ≈ 0.9、自己相関ピーク ≈ 0 | 非線形性（尖度 > 3.5）、共鳴（自己相関ピーク > 0.1）、着色（SF < 0.7） |
| `tone-burst` | 低い尖度、SF ≈ 0.9、自己相関ピーク ≈ 0 | リンギング（自己相関ピーク > 0.1、ラグ = リンギング周期）、プレエコー（高変調比 > 0.7） |
| `multitone` | 尖度 ≈ 3、SF ≈ 0.9 | IMD（SF < 0.7）、位相歪み（高変調比 > 0.7） |
| `sweep` | 尖度 ≈ 3、SF ≈ 0.9 | 周波数依存歪み（尖度が変動）、共鳴（自己相関ピークのスパイク） |

### 5.3 生成と分析の例

```bash
# 1. 参照信号を生成
uv run microstructure-metrics generate white-noise \
  --duration 10 --sample-rate 48000 --output ref.wav

# 2. デバイスに通す、または劣化をシミュレート
# （例：ループバック録音またはDSP処理による）

# 3. CLI reportを使用してRMIを計算
uv run microstructure-metrics report ref.wav dut.wav \
  --metrics residual --output report.json

# 4. 主要指標を確認
jq '.metrics.ch0.residual | {kurtosis, spectral_flatness, autocorr_peak_excess}' report.json
```

---

## 6. 参考文献

### 理論的背景

- **尖度とインパルス性**：Hyvarinen, A., & Oja, E. (2000). Independent component analysis: algorithms and applications. *Neural Networks*, 13(4-5), 411-430. – 信号特徴付けのための高次統計。
- **スペクトル平坦度**：Johnston, J. D. (1988). Transform coding of audio signals using perceptual noise criteria. *IEEE Journal on Selected Areas in Communications*, 6(2), 314-323. – スペクトル平坦度尺度によるトーン性推定。
- **変調伝達関数**：Drullman, R., Festen, J. M., & Plomp, R. (1994). Effect of temporal envelope smearing on speech reception. *Journal of the Acoustical Society of America*, 95(2), 1053-1064. – 包絡変調の知覚的関連性。

### 実装参考資料

- **Scipy 信号処理**：[https://docs.scipy.org/doc/scipy/reference/signal.html](https://docs.scipy.org/doc/scipy/reference/signal.html) – ヒルベルト変換、Welch PSD、相関関数。
- **NumPy 統計**：[https://numpy.org/doc/stable/reference/routines.statistics.html](https://numpy.org/doc/stable/reference/routines.statistics.html) – 尖度、パーセンタイル計算。

### 関連ドキュメント

- **指標の読み解きガイド**：`docs/jp/metrics-interpretation.md` – RMI を他の指標との文脈で説明。
- **信号仕様**：`docs/jp/signal-specifications.md` – 各テスト信号タイプの詳細パラメータ。
- **測定手順**：`docs/jp/measurement-setup.md` – レベル合わせと整列の実務的考慮。

### ソースコード

- **RMI 実装**：`src/microstructure_metrics/metrics/residual.py`
  - `calculate_residual_microstructure()`：RMIの中核計算
  - `ResidualMicrostructureResult`：RMI指標のデータ構造

- **テスト信号生成**：`src/microstructure_metrics/cli/generate.py`
  - RMI評価用の白色ノイズ、トーンバースト、マルチトーン、スイープ信号を含む

---

## 付録：RMI の一般的な落とし穴

1. **前処理の不備**：RMIは整列およびレベル合わせされた信号を必要とします。`calculate_residual_microstructure()` を呼び出す前に、パイロットトーンまたは相互相関で整列し、レベルを正規化してください。

2. **不完全な解釈**：低い残差RMS単独ではアーティファクトのないオーディオを保証しません。尖度、スペクトル平坦度、変調比、自己相関ピークを総合的に評価して、残差構造を判断してください。

3. **不適切なテスト信号**：RMIは複雑な信号（ノイズ、マルチトーン、過渡）で最も有益です。純粋なサイン波はIMD、包絡アーティファクト、または周波数依存の問題をマスクする可能性があります。

4. **信号長の不足**：尖度とスペクトル平坦度は安定性のために十分なサンプルを必要とします。信頼できる推定には≥10秒の信号を使用；短い信号（<1秒）は信頼性の低い統計を生成する可能性があります。

5. **パラメータの検証**：`autocorr_peak_lag_ms` が予想範囲外（<0.1 msまたは>10 ms）の場合、サンプルレートと `autocorr_max_lag_ms` の設定が信号タイプに適切か確認してください。
