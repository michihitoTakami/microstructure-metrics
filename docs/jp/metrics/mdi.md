# マイクロ構造分布ダイバージェンス (MDI: Microstructure Distribution Divergence)

## 1. 概要

### 目的と意義

**マイクロ構造分布ダイバージェンス (MDI)** は、時間的・空間的次元にわたるマイクロ構造特性の保存度を定量化する複合指標です。平均値のみを報告する従来の指標とは異なり、MDIは**分布の違い**に焦点を当てます。つまり、「ほとんどOKだが時々壊れる」パターン——単純な平均化では隠されてしまう間欠的なアーティファクト、散発的な位相不安定性、不一致な過渡応答を明らかにします。

### 測定対象

MDIは、複数の特徴ドメインからの分布ダイバージェンスを集約します：

- **TFS (時間微細構造)**: 包絡エネルギーで重み付けされた時間フレーム全体にわたる短時間相関値の分布、および周波数帯域間のグループ遅延偏差
- **トランジェント**: 検出された過渡イベント全体にわたる立ち上がり時間と幅特性の分布
- **バイノーラル** (ステレオのみ): 時間フレーム全体にわたるITD (両耳間時間差)、ILD (両耳間レベル差)、IACC (両耳間相互相関) の分布

この指標は、**1次元Wasserstein距離** (Earth Mover's Distance) を使用して、参照信号とDUT (被測定デバイス) 信号間の経験的分布を比較します。各コンポーネント・ダイバージェンスは、知覚的に動機付けられたスケール係数で正規化され、重み付けされた後、合計されて総MDIスコアを生成します。

### なぜ分布が重要か

人間の知覚は、音響特徴の時間的一貫性と統計的規則性に敏感です。平均値だけでは間欠的な問題を隠してしまいます——リスナーは、全体的なメトリクスが許容範囲内に見えても、相関の散発的な破綻、タイミングの不安定性、不一致な過渡応答を検出します。MDIは、間欠的アーティファクト、系統的な特徴変化、または複数ドメインにわたる相関劣化を示す、これらの**分布シフト**を捉えます。

### 典型的な応用場面

- 定常状態歪みを超えたマイクロ構造忠実度のためのDAC、アンプ、または信号チェーンの比較
- 熱ドリフト、電源リップル、または適応処理からの間欠的アーティファクトの検出
- コーデック品質の評価、特に時間変化するアーティファクトを導入する可能性のある知覚コーデック
- 分布一貫性のための音声処理アルゴリズム（DSP、リサンプリング、ディザリング）の検証

---

## 2. 数学的定義

### 2.1 Wasserstein距離 (Earth Mover's Distance)

2つの経験的分布 \(X = \{x_i\}\) と \(Y = \{y_j\}\) に対して、オプションの重み \(w^X_i\) と \(w^Y_j\) を持つ**1次元Wasserstein距離**は、一方の分布を他方に変換するために必要な最小の「仕事」を定量化します：

$$
W_1(X, Y) = \int_{-\infty}^{\infty} |F_X(t) - F_Y(t)| \, dt
$$

ここで、\(F_X(t)\) と \(F_Y(t)\) は累積分布関数 (CDF) です。

**主要な特性**：
- 三角不等式を満たす； \(W_1(X, Y) = 0\) iff 分布が同一
- 外れ値にロバスト（KLダイバージェンスと異なる）
- 結果は特徴の単位（ms、dB、相関ポイント）で表現され、解釈可能

### 2.2 MDIコンポーネントとスケーリング

各特徴ダイバージェンス \(D_i\) は、知覚的に動機付けられた係数 \(s_i\) でスケーリングされ、\(w_i\) で重み付けされます：

$$
\text{MDI}_{\text{total}} = \sum_i w_i \cdot \frac{D_i}{s_i}
$$

**コンポーネントまとめ**：

| コンポーネント | 計算式 | サンプル重み | スケール係数 | 測定対象 |
|-----------|---------|----------------|--------------|------------------|
| **TFS相関** | \(W_1(\{\rho_{k,m}\}, \{1.0\})\) | 包絡エネルギー | 0.1 | 完全相関（1.0）からの偏差 |
| **TFSグループ遅延** | \(W_1(\{\tau_k\}, \{0\text{ ms}\})\) | なし | 0.2 ms | 周波数依存のタイミングシフト |
| **トランジェント立ち上がり** | \(W_1(\{\text{attack}_{\text{ref}}\}, \{\text{attack}_{\text{dut}}\})\) | ピーク振幅 | 1.0 ms | 立ち上がりタイミングシフトまたは可変性 |
| **トランジェント幅** | \(W_1(\{\text{width}_{\text{ref}}\}, \{\text{width}_{\text{dut}}\})\) | ピーク振幅 | 1.0 ms | 持続時間変化（リンギング、スメアリング） |
| **バイノーラルITD** | \(W_1(\{\text{ITD}_{\text{ref}}\}, \{\text{ITD}_{\text{dut}}\})\) | 包絡エネルギー | 0.2 ms | 両耳間タイミング手がかりの変化 |
| **バイノーラルILD** | \(W_1(\{\text{ILD}_{\text{ref}}\}, \{\text{ILD}_{\text{dut}}\})\) | 包絡エネルギー | 1.0 dB | 両耳間レベル手がかりの変化 |
| **バイノーラルIACC** | \(W_1(\{\text{IACC}_{\text{ref}}\}, \{\text{IACC}_{\text{dut}}\})\) | 包絡エネルギー | 0.1 | チャネル間相関の変化 |

TFSおよびトランジェントコンポーネントはチャネルごとに計算；バイノーラルコンポーネントはステレオのみ。

### 2.3 集約と重み付け

**デフォルトのグループ重み** (\(w_i\))：
- TFS: 1.0
- トランジェント: 1.0
- バイノーラル: 1.0

**総スコア**：
$$
\text{MDI}_{\text{total}} = \text{MDI}_{\text{channels}} + \text{MDI}_{\text{binaural}}
$$

ここで：
- \(\text{MDI}_{\text{channels}}\) = すべてのチャネルごとのTFSおよびトランジェントコンポーネントの合計
- \(\text{MDI}_{\text{binaural}}\) = すべてのバイノーラルコンポーネントの合計（ステレオのみ）

**低いほど良好**: \(\text{MDI} = 0\) は完全な保存を示す；より高い値は分布ダイバージェンスを示す。

---

## 3. 実装詳細

### 3.1 パラメータと推奨値

MDIは、事前計算されたTFS、トランジェント、バイノーラル結果から計算されます。主要なパラメータはグループ重みです：

| パラメータ | 型 | デフォルト | 範囲/備考 |
|-----------|---|---------|---------|
| `weights["tfs"]` | float | 1.0 | TFSダイバージェンスの相対的重要度 |
| `weights["transient"]` | float | 1.0 | トランジェントダイバージェンスの相対的重要度 |
| `weights["binaural"]` | float | 1.0 | バイノーラルダイバージェンスの相対的重要度（ステレオのみ） |

**スケール係数**（知覚的一貫性のためにハードコード）：
- TFS相関: 0.1（相関ポイント）
- TFSグループ遅延: 0.2 ms
- トランジェント立ち上がり/幅: 1.0 ms
- バイノーラルITD: 0.2 ms
- バイノーラルILD: 1.0 dB
- バイノーラルIACC: 0.1

### 3.2 アルゴリズム概要

1. **前提条件**: 参照とDUT信号の両方についてTFS、トランジェント、バイノーラル指標を計算
   - TFS: `calculate_tfs_correlation()` は重み付きフレームごとの相関系列を返す必要がある
   - トランジェント: `calculate_transient()` は立ち上がり時間、幅、ピーク振幅を持つ検出イベントを返す必要がある
   - バイノーラル: `calculate_binaural()` は重み付きフレームごとのITD、ILD、IACC系列を返す必要がある

2. **チャネルごとの処理**：
   - 各チャネルについて、TFS相関系列とバンドグループ遅延を抽出
   - 理想値（相関は1.0、遅延は0 ms）へのWasserstein距離を計算
   - トランジェントイベント特徴（立ち上がり、幅）を抽出し、参照/DUT分布間のWasserstein距離を計算

3. **バイノーラル処理**（ステレオのみ）：
   - ITD、ILD、IACC系列を抽出
   - 正の重みを持つ有限値をフィルタ
   - 各特徴について参照/DUT分布間のWasserstein距離を計算

4. **集約**：
   - 各コンポーネントダイバージェンスをそのスケール係数でスケーリング
   - グループ重みを適用
   - すべてのコンポーネントを合計して総MDIスコアを生成

### 3.3 エッジケースと特別な処理

1. **空の分布**: 特徴系列が空の場合（例：トランジェントが検出されない）、Wasserstein距離はメトリックの失敗を避けるために0.0にデフォルト設定されます。これは保守的です；注意して解釈してください。

2. **不一致サンプル数**: Wasserstein距離は不等サンプル数を自然に処理します（参照とDUTは異なる数のトランジェントまたは有効フレームを持つ可能性があります）。

3. **無限またはNaN値**: 非有限値またはゼロ/負の重みを持つサンプルは、Wasserstein距離を計算する前にフィルタリングされます。

4. **モノ信号**: バイノーラルコンポーネントは計算されません；MDIはTFSとトランジェントダイバージェンスのみを反映します。

5. **ゼロ重み**: すべてのフレーム重みがゼロの場合（例：無音信号）、対応するコンポーネントダイバージェンスは0.0です。

### 3.4 計算複雑度

- **コンポーネントごとのWasserstein**: \(\mathcal{O}(N \log N)\) ここで \(N\) はサンプル数（ソートが支配的）
- **総複雑度**: \(\mathcal{O}(C \cdot K \cdot N \log N)\) ここで \(C\) はチャネル数、\(K\) は特徴タイプ数（~5-7）

実行時間の目安：事前計算されたTFS/トランジェント/バイノーラル結果を前提として、すべてのコンポーネントで 50 ms未満。

---

## 4. 解釈ガイドライン

### 4.1 総合スコア範囲

**MDI総合** (\(\text{MDI}_{\text{total}}\))：

- **< 1.0**: 優れたマイクロ構造保存；最小限の分布ダイバージェンス
- **1.0–2.0**: 非常に良好；軽微な分布シフト、ほとんどのアプリケーションで許容可能
- **2.0–5.0**: 許容可能；顕著だが深刻でないダイバージェンス、批判的リスニングで聴こえる可能性
- **> 5.0**: 有意なマイクロ構造劣化；系統的または間欠的なアーティファクトが存在

### 4.2 コンポーネントレベルの解釈

**コンポーネント総計** (`component_totals` 辞書)：
- `channels`: すべてのチャネルごとのTFSおよびトランジェントダイバージェンスの合計
- `binaural`: すべてのバイノーラルダイバージェンスの合計（ステレオのみ）

**チャネルごとの総計** (`channel_totals` 辞書)：
- チャネル名（例："L"、"R"）をそのチャネルのTFS + トランジェントダイバージェンスの合計にマッピング
- チャネル固有の問題を特定するのに有用

**個別コンポーネント** (`components` リスト)：
- 各コンポーネントには以下があります：
  - `name`: 例："L.tfs.correlation_to_ideal"、"L.transient.attack_time_ms"、"binaural.itd_ms"
  - `distance`: 生のWasserstein距離（特徴単位：ms、dB、相関ポイント）
  - `weight`: 適用されたグループ重み
  - `scale`: 正規化に使用されたスケール係数
  - `samples_ref`、`samples_dut`: 分布比較に使用された有効サンプル数

**診断ワークフロー**：
1. `mdi_total` を確認：高い場合（> 2.0）、コンポーネント分析に進む
2. `channels_total` vs `binaural_total` を比較：劣化が空間的か時間的かを特定
3. `channel_totals` を検査：1つのチャネルが悪化しているか確認（非対称劣化）
4. 個別の `components` を調査：高いダイバージェンスを持つ特定の特徴タイプを特定（例：TFS相関 vs トランジェント立ち上がり）

### 4.3 他のメトリクスとの相関

**MDI vs 平均TFS相関**：
- 高TFS相関（例：0.95）で高MDIは**時間的不安定性**を示唆：ほとんどのフレームは良好だが、いくつかの外れ値が非常に低い相関を持つ
- 低TFS相関（例：0.80）で低MDIは**系統的劣化**を示唆：一貫して平凡だが間欠的ではない

**MDI vs THD+N**：
- 低THD+N（例：-100 dB）で高MDIは、定常状態測定では現れない**動的非線形性**を示す
- 高THD+Nで低MDIは、マイクロ構造問題のない定常状態歪みを示唆

### 4.4 一般的なパターン

**シナリオ：高TFSダイバージェンス、低トランジェントダイバージェンス**
- 可能性：過渡タイミングに大きく影響しない位相不安定性、ジッタ、またはグループ遅延異常
- 確認：周波数依存遅延についてTFSバンドグループ遅延を確認

**シナリオ：高トランジェントダイバージェンス、低TFSダイバージェンス**
- 可能性：イベント特性に影響するが微細構造には影響しないスルーレート制限、包絡クリッピング、または立ち上がり丸まり
- 確認：系統的シフトについてトランジェント立ち上がり時間と幅分布を確認

**シナリオ：高バイノーラルダイバージェンス、低他のコンポーネント**
- 可能性：ステレオチャネル不均衡、位相不一致、またはチャネル間クロストーク
- 確認：レベル不一致についてILD、タイミングエラーについてITD、無相関についてIACCを確認

**シナリオ：すべてのコンポーネントで高ダイバージェンス**
- 可能性：深刻な非線形性、帯域制限、または系統的信号劣化
- 確認：まず基本的なメトリクス（THD+N、周波数応答）を確認；MDIは複数ドメインへの影響を確認

---

## 5. 推奨テスト信号

MDIは、TFS、トランジェント、バイノーラル結果から計算される**二次メトリクス**です。適切なテスト信号は以下の条件を満たすべきです：
- 高周波内容（2–8 kHz）でTFSバンドを励起
- 変化する立ち上がり特性を持つ過渡イベントを含む
- ステレオの場合：空間情報（ITD、ILD、IACC）を含む

詳細な信号推奨については、個別のメトリクスドキュメント（`tfs.md`、`transient.md`）を参照してください。一般的に：
- **トーンバースト**と**AM変調信号**は分布シフトに高感度
- **マルチトーン**は定常状態に近い挙動のベースラインを提供
- **音楽または複雑なプログラム素材**は実世界の検証を提供し、より高い許容度（通常MDI < 3.0が許容可能）

どのドメインが総MDIに最も寄与するかを理解するために常にコンポーネント内訳を検査し、信号依存のアーティファクトを特定するために複数の信号にわたって比較してください。

---

## 6. 参考文献

### 理論的背景

- **Wasserstein距離**: Villani, C. (2009). *Optimal Transport: Old and New*. Springer. – 最適輸送理論とEarth Mover's Distanceの包括的な扱い。
- **音声の分布メトリクス**: Marins, M. A., et al. (2018). Improved similarity measures for histogram-based signatures. *Pattern Recognition Letters*, 105, 47–53.
- **時間変動性の知覚的重要性**: Moore, B. C. J. (2012). *An Introduction to the Psychology of Hearing* (6th ed.). Brill. – 時間統合とタイミングおよび相関のJND。

### 実装参考資料

- **NumPy統計関数**: [https://numpy.org/doc/stable/reference/routines.statistics.html](https://numpy.org/doc/stable/reference/routines.statistics.html)
- **SciPy Wasserstein距離**（参照、この実装では使用されていませんが）: [https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.wasserstein_distance.html](https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.wasserstein_distance.html)

### 関連ドキュメント

- **TFSメトリクス**: `docs/jp/metrics/tfs.md` – 時間微細構造相関と位相コヒーレンス
- **トランジェントメトリクス**: `docs/jp/metrics/transient.md` – 過渡イベント検出と特性評価
- **バイノーラルメトリクス**: (利用可能な場合) – ITD、ILD、IACC計算
- **指標の読み解きガイド**: `docs/jp/metrics-interpretation.md` – MDIを他のメトリクスと組み合わせて使用する一般的なガイダンス
- **測定手順**: `docs/jp/measurement-setup.md` – レベル合わせと整列の実務的考慮

### ソースコード

- **MDI実装**: `src/microstructure_metrics/metrics/divergence.py`
  - `calculate_microstructure_distribution_divergence()`: 主要なMDI計算
  - `wasserstein_1d()`: オプション重み付き1次元Wasserstein距離

---

## 付録：MDIの一般的な落とし穴

1. **異なる信号タイプ間でMDIを比較**: MDIは信号依存；トーンバーストは自然に複雑な音楽よりも低いMDIを持ちます。同種で比較してください。

2. **サンプル数を無視**: `samples_dut` が非常に低い場合（例：< 10）、分布比較は信頼できません。`components` でサンプル数を確認してください。

3. **信号整列を忘れる**: MDIは参照とDUTが事前整列されていることを前提としています。不整列はトランジェントダイバージェンスとTFSグループ遅延を膨張させます。

4. **知覚品質との単調な関係を仮定**: MDIは分布ダイバージェンスを測定し、知覚距離ではありません。高いMDIは、リスナーとコンテキストに応じて聴こえる場合と聴こえない場合があります。
